<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/1.1.0/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.0.0/css/responsive.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/colreorder/1.3.0/css/colReorder.dataTables.min.css" rel="stylesheet">

</head>
<body>

<table id="upwork" class="display  compact" cellspacing="0" width="100%">
    <thead>
    <tr>
        <th>Id</th>
        <th>Rating</th>
        <th>Created_at</th>
        <th>Title</th>
        <th>Description</th>
        <th>Type</th>
        <th>Budget</th>
        <th>Engagement</th>
        <th>EngagementWeeks</th>
        <th>Contractor Tier</th>
        <th>Url</th>
        <th>Job Id</th>
        <th>Skills</th>
    </tr>
    <!--<tr>-->
    <!--<th>Id</th>-->
    <!--<th>Job Id</th>-->
    <!--<th>Url</th>-->
    <!--<th>Created_at</th>-->
    <!--<th>Title</th>-->
    <!--<th>Description</th>-->
    <!--<th>Type</th>-->
    <!--<th>Budget</th>-->
    <!--<th>Engagement</th>-->
    <!--<th>EngagementWeeks</th>-->
    <!--<th>Contractor Tier</th>-->
    <!--<th>Skills</th>-->
    <!--<th>Rating</th>-->
    <!--</tr>-->
    </thead>
    <tfoot>
    <tr>
        <th>id</th>
        <th>Rating</th>
        <th>Created_at</th>
        <th>Title</th>
        <th>Description</th>
        <th>Type</th>
        <th>Budget</th>
        <th>Engagement</th>
        <th>EngagementWeeks</th>
        <th>Contractor Tier</th>
        <th>Url</th>
        <th>Job_id</th>
        <th>Skills</th>
    </tr>
    </tfoot>
</table>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.flash.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.0.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.3.0/js/dataTables.colReorder.min.js"></script>
<script src="/jquery.dataTables.columnFilter.js"></script>
<script src="/rater.min.js" charset="utf-8"></script>
<script>
    var options = {
        ajax_method: 'GET',
        url: '/update_rating.php',
        step_size: 1,
        additional_data: {}
    };

    $(function () {
        $.datepicker.regional[""].dateFormat = 'dd-mm-yy';
        $.datepicker.setDefaults($.datepicker.regional['']);
        var prev_rowid = undefined;
        var prev_rating = undefined;
        $('#upwork')
                .dataTable({
                    "order": [0, 'desc'],
                    "ajax": "/get_data.php",
                    responsive: true,
                    colReorder: true,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'copy',
                            text: '<b><u>C</u></b>opy',
                            key: {
                                key: 'c',
                                ctrlKey: true
                            }
                        },
                        'csv',
                        'excel',
                        'pdf',
                        {
                            extend: 'print',
                            text: '<b><u>P</u></b>rint',
                            key: {
                                key: 'p',
                                ctrlKey: true
                            }
                        },
                        {
                            extend: 'colvis',
                            text: '<span class="glyphicon glyphicon-filter" aria-hidden="true">'
                        },
                        {
                            text: '<span class="glyphicon glyphicon-asterisk" aria-hidden="true">',
                            action: function () {
                                $('.filter_column').find('input').val(function () {
                                    return $(this).attr('value')
                                });
                                $('.select_filter').find('.search_init').attr('selected', true);
                                $('.filter_date_range').find('input').val('').click();
                                $('.filter_number_range').find('input').val('').click();
                                $('#upwork').DataTable().search('').columns().search('');
                                $('#upwork').DataTable().order([0, 'desc']).draw();
                            }
                        },
                        {
                            text: '<span class="glyphicon glyphicon-refresh" aria-hidden="true">',
                            action: function () {

                            }
                        },
                        {
                            text: '<span class="glyphicon glyphicon-download-alt" aria-hidden="true">',
                            action: function () {

                            }
                        }
                    ],
                    "columns": [
                        {
                            "data": "id",
                            responsivePriority: 1
                        },
                        {
                            "data": "rating",
                            "render": function (data, type, row, meta) {
                                return type === 'display' ?
                                '<div class="rate" style="font-size: 24px;" id="' + row.id + '" data-rate-value="' + data + '" data-row="' +
                                meta.row + '" data-col="' + meta.col + '" data-id="' + row.id + '">' : data;
                            },
                            responsivePriority: 2
                        },
                        {
                            "data": {
                                _: "created_at.display",
                                sort: "created_at.timestamp"
                            },
                            responsivePriority: 3
                        },
                        {
                            "data": "title",
                            responsivePriority: 4
                        },
                        {
                            "data": "description",
                            "render": function (data, type, full, meta) {
                                return type === 'display' && data.length > 100 ?
                                '<span title="' + data + '">' + data.substr(0, 98) + '...</span>' : data;
                            },
                            responsivePriority: 13
                        },
                        {
                            "data": "type",
                            responsivePriority: 5
                        },
                        {
                            "data": "budget",
                            responsivePriority: 6
                        },
                        {
                            "data": "engagement",
                            responsivePriority: 7
                        },
                        {
                            "data": "engagement_weeks",
                            responsivePriority: 8
                        },
                        {
                            "data": "contractor_tier",
                            responsivePriority: 9
                        },
                        {
                            "data": "url",
                            "render": function (data, type, full, meta) {
                                return '<a href="' + data + '" target="_blank">' + data + '</a>';
                            },
                            responsivePriority: 11
                        },
                        {
                            "data": "job_id",
                            responsivePriority: 12
                        },
                        {
                            "data": "skills",
                            responsivePriority: 10
                        }
                    ]
                }).columnFilter({
//                    sPlaceHolder: "head:before",
                    aoColumns: [
//                        {type: "number"},
                        null,
                        {type: "select", values: [0, 1, 2, 3, 4, 5]},
                        {type: "date-range", sRangeFormat: "Created between {from} and {to}"},
                        {type: "text"},
                        {type: "text"},
                        {type: "select", values: ['Fixed', 'Hourly']},
                        {type: "number-range", sRangeFormat: "Budget from {from} to {to}"},
                        {type: "select", values: ['Full-time', 'Part-time', 'As needed']},
                        null,
                        {type: "select", values: [1, 2, 3, 8]},
                        null,
                        null,
                        {type: "text"}
                    ]
                }).on('draw.dt', function () {
                    console.log('qq');
//                    $('#upwork').DataTable().colReorder.transpose([0,1,2,3,4,5,6,7,8,9,10,11,12]);
                    $('#upwork').DataTable().on('column-reorder', function (e, settings, details) {

                        console.log('zz');
                        $(".rate").rate(options);
                        $(".rate").on("change", function (ev, data) {
                            var rowid = $(ev.target).attr('id');
                            var rating = data.to;
                            if (prev_rowid != rowid || prev_rating != rating) {
                                var row = $(this).attr('data-row');
                                var col = $(this).attr('data-col');
                                prev_rowid = options.additional_data.id = rowid;
                                prev_rating = options.additional_data.rating = rating;
                                $('#upwork').DataTable().cell(row, col).data(rating).draw('page');
                            }
                        });
                    });
                    $(".rate").rate(options);
                    $(".rate").on("change", function (ev, data) {
                        var rowid = $(ev.target).attr('id');
                        var rating = data.to;
                        if (prev_rowid != rowid || prev_rating != rating) {
                            var row = $(this).attr('data-row');
                            var col = $(this).attr('data-col');
                            prev_rowid = options.additional_data.id = rowid;
                            prev_rating = options.additional_data.rating = rating;
                            $('#upwork').DataTable().cell(row, col).data(rating).draw('page');
                        }
                    });

                });
    });
</script>

</body>
</html>
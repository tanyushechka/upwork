<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/1.1.0/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

</head>
<body>
<div class="btn-group btn-group-sm pull-right" role="group" aria-label="First group">
    <button type="button" class="btn btn-default" id="button-clear-filter">
        <span class="glyphicon glyphicon-asterisk" aria-hidden="true">
        </span>
    </button>
    <button type="button" class="btn btn-default" id="button-refresh">
        <span class="glyphicon glyphicon-refresh" aria-hidden="true">
        </span>
    </button>
    <button type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-search" aria-hidden="true" id="button-search">
        </span>
    </button>
</div>
<table id="upwork" class="display  compact" cellspacing="0" width="100%">
    <thead>
    <tr>
        <th>Id</th>
        <th>Job Id</th>
        <th>Url</th>
        <th>Created_at</th>
        <th>Title</th>
        <th>Description</th>
        <th>Type</th>
        <th>Budget</th>
        <th>Engagement</th>
        <th>EngagementWeeks</th>
        <th>Contractor Tier</th>
        <th>Skills</th>
        <th>Rating</th>
    </tr>
    <tr>
        <th>Id</th>
        <th>Job Id</th>
        <th>Url</th>
        <th>Created_at</th>
        <th>Title</th>
        <th>Description</th>
        <th>Type</th>
        <th>Budget</th>
        <th>Engagement</th>
        <th>EngagementWeeks</th>
        <th>Contractor Tier</th>
        <th>Skills</th>
        <th>Rating</th>
    </tr>
    </thead>
    <tfoot>
    <tr>
        <th>id</th>
        <th>job_id</th>
        <th>Url</th>
        <th>Created_at</th>
        <th>Title</th>
        <th>Description</th>
        <th>Type</th>
        <th>Budget</th>
        <th>Engagement</th>
        <th>EngagementWeeks</th>
        <th>Contractor Tier</th>
        <th>Skills</th>
        <th>Rating</th>
    </tr>
    </tfoot>
</table>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.colVis.min.js"></script>
<script src="/jquery.dataTables.columnFilter.js"></script>
<script src="/rater.min.js" charset="utf-8"></script>
<script>
    var options = {
        ajax_method: 'GET',
        url: '/update_rating.php',
        step_size: 1,
        additional_data: {}
    };

    $(function () {
        $.datepicker.regional[""].dateFormat = 'dd-mm-yy';
        $.datepicker.setDefaults($.datepicker.regional['']);
        var prev_rowid = undefined;
        var prev_rating = undefined;
        $('#upwork')
                .dataTable({
                    "order": [0, 'desc'],
                    "ajax": "/get_data.php",
                    dom: 'Bfrtip',
                    buttons: [
                        'colvis'
                    ],
                    "columns": [
                        {"data": "id"},
                        {"data": "job_id"},
                        {
                            "data": "url",
                            "render": function (data, type, full, meta) {
                                return '<a href="' + data + '" target="_blank">' + data + '</a>';
                            }
                        },
                        {
                            "data": {
                                _: "created_at.display",
                                sort: "created_at.timestamp"
                            }
                        },
                        {"data": "title"},
                        {"data": "description",
                            "render": function (data, type, full, meta) {
                                return type === 'display' && data.length > 100 ?
                                '<span title="' + data + '">' + data.substr(0, 98) + '...</span>' : data;
                            }},
                        {"data": "type"},
                        {"data": "budget"},
                        {"data": "engagement"},
                        {"data": "engagement_weeks"},
                        {"data": "contractor_tier"},
                        {"data": "skills"},
                        {
                            "data": "rating",
                            "render": function (data, type, row, meta) {
                                return type === 'display' ?
                                '<div class="rate" style="font-size: 24px;" id="' + row.id + '" data-rate-value="' + data + '" data-row="' +
                                meta.row + '" data-col="' + meta.col + '" data-id="' + row.id + '">' : data;
                            }
                        }
                    ]
                }).columnFilter({
                    sPlaceHolder: "head:before",
                    aoColumns: [
                        {type: "number"},
                        null,
                        null,
                        {type: "date-range", sRangeFormat: "Created between {from} and {to}"},
                        {type: "text"},
                        {type: "text"},
                        {type: "select", values: ['Fixed', 'Hourly']},
                        {type: "number-range", sRangeFormat: "Budget from {from} to {to}"},
                        {type: "select", values: ['Full-time', 'Part-time', 'As needed']},
                        null,
                        {type: "select", values: [1, 2, 3, 8]},
                        {type: "text"},
                        {type: "select", values: [0, 1, 2, 3, 4, 5]}
                    ]
                }).on('draw.dt', function () {
                    $(".rate").rate(options);
                    $(".rate").on("change", function (ev, data) {
                        var rowid = $(ev.target).attr('id');
                        var rating = data.to;
                        if (prev_rowid != rowid || prev_rating != rating) {
                            var row = $(this).attr('data-row');
                            var col = $(this).attr('data-col');
                            prev_rowid = options.additional_data.id = rowid;
                            prev_rating = options.additional_data.rating = rating;
                            $('#upwork').DataTable().cell(row, col).data(rating).draw('page');
                        }
                    });

                });

        $('#button-clear-filter').click(function () {
            $('.filter_column').find('input').val(function () {
                return $(this).attr('value')
            });
            $('.select_filter').find('.search_init').attr('selected', true);
            $('.filter_date_range').find('input').val('').click();
            $('.filter_number_range').find('input').val('').click();
            $('#upwork').DataTable().search('').columns().search('');
            $('#upwork').DataTable().order([0, 'desc']).draw();
        });

        $('#button-refresh').click(function () {
//            $('#upwork').DataTable().search('').columns().search('').draw();
//            $('.filter_column').find('input').val(function () {
//                return $(this).attr('value')
//            });
//            $('.filter_date_range').find('input').val('').click();
//            $('.filter_number_range').find('input').val('').click();

        });


    });
</script>

</body>
</html>